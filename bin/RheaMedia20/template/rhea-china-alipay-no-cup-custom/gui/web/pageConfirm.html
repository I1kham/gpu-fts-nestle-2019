<html>
<head>
	<title>GUI</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="style.css" rel="stylesheet" type="text/css">
	<link href="styleOptionButtons.css" rel="stylesheet" type="text/css">
</head>

<body onLoad="rheaBootstrap()">

<div id="mainWrapper" class="wrapper1024x600">
	<div class="header">
		<center><img src="img/logo_rhea.jpg"></center> 	
	</div>
	
	<div class="pageConfirm">
		<div class="pageConfirm_center">
			<div id="divSelectionImage" class="pageConfirm_selectionImage"></div>
			<div id="divBtnSelectionInfo" class="pageConfirm_selectionInfo" style="display:none" onclick="gotoSelectionInfo()"><img draggable='false' src="img/info.png"></div>
			<div class="pageConfirm_selectionBottom pageConfirm_bigFont" id="divPrice"></div>
		</div>
		
		
		<div class="pageConfirm_right" style="position:relative;">
			<div id="rightPane_wait" style="display:none; text-align:center">
				<table border="0" cellspacing="0" cellpadding="0" style="width:100%; height:100%">
					<tr valign="middle">
						<td align="center">
							<div style="height:380px">
								<div id="qrcode_plsWait" style="margin:20px auto 0 auto; width:256px; height:256px;"><img src="img/animationRound.gif"></div>
								<div id="qrcode_payment" style="display:none;">
									<div id="qrcode_text">Please, scan the QR code in order to proceed with the payment</div>
									<div id="qrcode" style="margin:40px auto auto auto; width:258px; height:258px; padding: 1px; background-color:#fff"></div>
								</div>
							</div>
							<div id="btnAbortPayment" class="btnStart pageConfirm_bigFont" onclick="onBtnAbortPayment()">ABORT</div>
						</td>
					</tr>
				</table>
			</div>
			<div id="rightPane_content">
				<div class="pageConfirm_right3box">
					<div class="pageConfirm_bigFont" style="margin-bottom:10px" id="divSelectionName"></div>
					<div class="pageConfirm_selectionNdName pageConfirm_bigFont" id="divSelectionNdName" style="display:none"></div>
					<div id="selDescription"></div>
				</div>
				<div class="pageConfirm_bottomBox">
					<div style="text-align:center">
						<div style="float:left; margin-right:10px"><img src="img/alipay-logo.jpg"></div>
						<div style="float:left; margin-right:10px"><img src="img/unionpay-logo.jpg"></div>
						<div style="float:left"><img src="img/wechatpay-logo.jpg"></div>
						<div class="clear"></div>
					</div>
					<table border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
						<tr valign="middle">
							<td align="middle">
								<div id="btnStart" class="btnStart pageConfirm_bigFont" onclick="onBtnStartSelection()"></div>
								<div id="btnStartNotAvail" class="btnStartNotAvail" style="display:none"></div>
								<div id="btnStartOffline" class="btnStartNotAvail" style="display:none"></div>
							</td>
						</tr>
					</table>			
				</div>
			</div>
		</div>
		
		<div class="clear"></div>
	</div>
	
	
	<div class="pageConfirm_footer">
		<div id="divCPUMessage" style="width:100%; text-align:center"></div></td></tr>
	</div>

	<!-- btn jug -->
	<div id="btnJUG" class="pageConfirm_btnJUG selected" style="display:none; position:absolute; top:471px; left:451px;" onclick="onBtnJUGClicked()"><p id="btnJUG_text"></p></div>
	
	<!-- il btn home lo metto qui in position absolute per dargli una maggiore area di click -->
	<div id="divBtnHome" class="btnIndietro"><img draggable='false' src="img/btnHome.png"></div>
	
	<div id="divWIFI" class="wifiSpot"><img src='img/wifi-on.png'></div>
</div> <!-- wrapper1024x600 -->



<script src="config/lang.js"></script>
<script src="config/mainMenuIcons.js"></script>
<script src="config/pageConfirm.js"></script>
<script src="config/MMI.js"></script>
<script src="js/rheaBootstrap.js"></script>
<script src="js/qrcode/qrcode.min.js"></script>
<script language="javascript">
var iconNum = 0;
var isRFIDJugDetected = 0;
var iconDisplayName="";
var selThatWasStarted = 0;
var GRINDER = 0;
var CUP_SIZE = 0;
var SHOT_TYPE = 0;
var qrcode = null;
var timerGotoMainMenu = null;

var JUG_STATUS = {
	ALWAYS_VISIBLE: 1,
	NEVER_VISIBLE: 2,
	ON_RFID_STATUS: 3
};

function isJUG()					{ if (iconDisplayName=="JUG") return true; return false;}
function isRheamediaPreview()				{ if (Rhea_session_getOrDefault("rheamedia2preview","0")=="1") return 1; return 0; }

function onRheaBootstrapFinished() 
{
	lang_loadLang(lang_getCurLangISOCode()).then (onAfterLangLoaded);
}

function onAfterLangLoaded()
{
	lang_loadJS ("cupAppearance")
		.then ( function()	
		{
			onAfterLangLoaded2();
		});
}

function onAfterLangLoaded2()
{
	//in get ci deve essere il parametro che indica quale iconMenu è stata selezionata
	iconNum = parseInt(rheaGetURLParamOrDefault("iconMenu", 0));

	//carica le nutritional info
	lang_loadJS ("nutriInfo").then ( function()
	{
		if (rheaLang_nutriInfo[iconNum] != "")
			rheaShowElem(rheaGetElemByID("divBtnSelectionInfo"));
	});
		
		
	rhea.onEvent_creditUpdated = function ()
	{
		doUpdateCredit();
	}
	
	rhea.onEvent_cpuMessage = function(msg, importanceLevel)
	{
		var dCPU = rheaGetElemByID ("divCPUMessage");
		if (importanceLevel == 0)
			rheaHideElem(dCPU)
		else
		{				
			rheaSetElemHTML(dCPU, msg);
			rheaShowElem(dCPU);
		}
	}
	
	rhea.onEvent_selectionReqStatus = function (status)
	{
		switch (status)
		{
			case 1: // wait for credit
				console.log ("sel waiting..");
				break;
				
			case 2:// selection started
			case 5:// selection started, can use btnStop
				//chiedo il num della selezione running
				rhea.ajax ("getCurSelRunning", "").then( function(result)
				{
					var selNum = parseInt(result);
					if (selNum >0)
					{
						var bCanUseBtnStop=0;
						if (status == 5)
							bCanUseBtnStop=1;
						var iconNum = MMI_fromSelNumToIconNum(selNum);
						var url = "pageSelInProgress.html";
						url += "?iconMenu=" +iconNum +"&selNum=" +selNum +"&btnStop=" +bCanUseBtnStop;
						window.location = url;
					}
				})
				.catch( function(result)
				{
				});			
				break;

			default:				
			case 3: // selection aborted
				console.log ("sel aborted [" +status +"]");
				var dContent = rheaGetElemByID("rightPane_content");
				var dWait = rheaGetElemByID("rightPane_wait");
				rheaHideElem(dWait);
				rheaSetDisplayMode(dContent, "inline-block");
				selThatWasStarted = 0;
				rheaShowElem(rheaGetElemByID("divBtnHome")); //btn back
				rheaShowElem(rheaGetElemByID("divBtnSelectionInfo")); //btn selection info
				break;
		}
	}
	
	rhea.onEvent_cpuStatus = function( statusID, statusStr, flag16 ) {
		console.log ("onEvent_cpuStatus[" +statusID +"][" +statusStr +"][" +flag16 +"]");

		if ( parseInt(statusID) === 8 ) {	// Start of washing process
			gotoRinsingPage();
		}

		if (isRFIDJugDetected) {
			if ((flag16 & 0x0040) == 0){
				isRFIDJugDetected = 0;
				toggleJugIcons( false );
			}
		} else {
			if ((flag16 & 0x0040) != 0) {
				isRFIDJugDetected = 1;
				toggleJugIcons( true );
			}
		}
	}

	rhea.onEvent_alipayChinaOnlineStatus = function (isOnline)
	{
		updateWifiIcon();
	}	
		
	setupPageContent();

	doUpdateCredit();
	rhea.requestGPUEvent(RHEA_EVENT_CPU_MESSAGE);
	rhea.requestGPUEvent(RHEA_EVENT_CPU_STATUS);
	rhea.requestGPUEvent(RHEA_EVENT_ALIPAYCHINA_ONLINE_STATUS);

	//invece che "onclick", trappo l'evento "mouse up" cheè più affidabile sul touchscreen
	var d = rheaGetElemByID("divBtnHome");
	d.addEventListener('mouseup', function (ev)
	{
		window.location = "pageMenu.html";
	}, true);	
	
	rheaSetDivHTMLByName ("qrcode_text", rheaLang.LAB_PLEASE_SCAN_QRCODE);
	resetTimerGotoPageMainMenu();
}

function onSelectionChanged(selNum)
{
	resetTimerGotoPageMainMenu();
	var selInfo = rhea.selection_getBySelNumber(selNum);
	
	var elemPrice = rheaGetElemByID("divPrice");
	if (rhea.isFreevend == 1)
	{
		rheaSetElemHTML(elemPrice, "FREEVEND");
		rheaShowElem (elemPrice);
	}
	else if (rhea.isTestvend == 1)
	{
		rheaSetElemHTML(elemPrice, "TESTVEND");
		rheaShowElem (elemPrice);
	}
	else if (isJUG())
	{
		rheaHideElem(elemPrice);
	}
	else
	{	
		rheaSetElemHTML(elemPrice, selInfo.price +" " +rheaLang.LAB_CURRENCY_SIMBOL);
		if (parseFloat(selInfo.price) <= 0)
			rheaHideElem (elemPrice);
		else
			rheaShowElem (elemPrice);
	}		

	var btnStart = rheaGetElemByID("btnStart");
	var btnStartNotAvail = rheaGetElemByID("btnStartNotAvail");
	var btnStartOffline = rheaGetElemByID("btnStartOffline");		
	
	//se selezione disabilitata, mostro START_NOT_AVAIL
	if (selInfo.enabled == "0")
	{
		rheaHideElem(btnStart);
		rheaHideElem(btnStartOffline);
		rheaSetElemHTML(btnStartNotAvail, rheaLang.BTN_START_SELECTION_NOT_AVAIL);
		rheaShowElem(btnStartNotAvail);
	}
	else
	{
		var bShowBtnStart = 0;
		
		//se wifi==ON...
		if (rhea.isAlipayChinaOnline() || isRheamediaPreview())
			bShowBtnStart = 1;
		else
		{
			//se wifi==OFF ma siamo in FREEVEND oppure prezzo==0
			if (parseFloat(selInfo.price) <= 0 || rhea.isFreevend)
				bShowBtnStart = 1;
		}
		
		if (bShowBtnStart)
		{
			rheaHideElem(btnStartNotAvail);
			rheaHideElem(btnStartOffline);
			if (isJUG())
			{
				rheaRemoveClassToElem (btnStart, "pageConfirm_bigFont");
				rheaSetElemHTML (btnStart, "CHOOSE A BEVERAGE");
			}
			else
				rheaSetElemHTML(btnStart, rheaLang.BTN_START_SELECTION);
			rheaShowElem(btnStart);
		}
		else
		{
			//nascondo il btn START e mostro il msg di "server non disponibile"
			rheaHideElem(rheaGetElemByID("btnStart"));
			rheaHideElem(rheaGetElemByID("btnStartNotAvail"));
			rheaSetElemHTML(btnStartOffline, rheaLang.BTN_START_OFFLINE);
			rheaShowElem(btnStartOffline);
		}
		
	}

	//jug btn
	if (selInfo.jug > 1) {
		if( 
			( jugConfiguration === JUG_STATUS.ALWAYS_VISIBLE ) || 
			( jugConfiguration === JUG_STATUS.ON_RFID_STATUS && isRFIDJugDetected )
		) {
			btnJUG_setON();
			btnJUG_setText (selInfo.jug);
			btnJUG_show();
		} else if ( jugConfiguration === JUG_STATUS.ON_RFID_STATUS && !isRFIDJugDetected ) {
			btnJUG_setOFF();
			btnJUG_hide();
		}
	} else {
		btnJUG_setOFF();
		btnJUG_hide();
	}

	if (rheaDebug_isEnabled())
		rheaDebug_addText ("selection:" +selNum);
}

function toggleJugIcons( show ) {
	if (jugConfiguration === JUG_STATUS.ON_RFID_STATUS) {
		if( show ) {
			var selNum = detectCurrentSelection();
			var selInfo = rhea.selection_getBySelNumber(selNum);

			if( selInfo.jug ) {
				btnJUG_setON();
				btnJUG_setText (selInfo.jug);
				btnJUG_show();
			}
		} else {
			btnJUG_setOFF();
			btnJUG_hide();
		}
	}
}

function doUpdateCredit()
{
	//rheaSetDivHTMLByName("divCredit", rhea.credit);	
}

var iconDisplayName="";
function setupPageContent()
{
	iconDisplayName = MMI_getDisplayName(iconNum);
	var image = "<img draggable='false' src='" +MMI_getImgForPageConfirm(iconNum) +"'>";
	var selNum = MMI_getLinkedSelectionNumber(iconNum);
	
	
	//colonna sinistra, foto bevanda
	var d = rheaGetElemByID("divSelectionImage");
	rheaSetElemHTML(d, image);
	
	//nome bevanda
	rheaSetDivHTMLByName("divSelectionName", iconDisplayName);
	
	//secondo nome bevanda
	if (typeof rhea_mainMenuIconSecondName !== 'undefined' && 
		rhea_mainMenuIconSecondName[iconNum] && 
		rhea_mainMenuIconSecondName[iconNum] !== 'NULL') {

		var elSecondName = rheaGetElemByID("divSelectionNdName");
		rheaSetElemHTML( elSecondName, rhea_mainMenuIconSecondName[iconNum] );
		rheaShowElem( elSecondName );
	}
	
	//colonna destra
	var bShowOption1 = 0;
	var bShowOption2 = 0;
	var bShowCupDiv = 0;
	
	//carica la descrizione della bevanda
	lang_loadJS ("mainMenuIconsInfo").then ( function()
	{
		var e = document.getElementById("selDescription");
		e.innerHTML = rheaMainMenuIconsInfo[iconNum];
		rheaShowElem(e);
	});	

	onSelectionChanged(selNum);
}

function detectCurrentSelection()
{
	var selNum = MMI_getLinkedSelectionNumber(iconNum);
	if (selNum == 0)
		selNum = MMI_getLinkedSelection (iconNum, GRINDER, CUP_SIZE, SHOT_TYPE);
	return selNum;
}


var btnAbort_secondsLeft = pageConfirmOptions.abortSec;
function btnAbort_countdown()
{
	var d = rheaGetElemByID("btnAbortPayment");
	btnAbort_secondsLeft--;
	rheaSetElemHTML (d, rheaLang.BTN_ABORT +" " +btnAbort_secondsLeft);

	if (btnAbort_secondsLeft <= 0)
	{
		onBtnAbortPayment();
		return;
	}
	
	//se siamo in preview, faccio partire la selezione dopo 3 secondi da quando è comparso il qr
	if (isRheamediaPreview())
	{
		if (btnAbort_secondsLeft <= pageConfirmOptions.abortSec-3)
		{
			startCurrentSelWithPaymentConfirmed();
			return;
		}
	}

	setTimeout (btnAbort_countdown, 1000);
}

function onBtnAbortPayment()
{
	rheaHideElem (rheaGetElemByID("btnAbortPayment"));
	rheaHideElem (rheaGetElemByID("qrcode_payment"));
	rheaHideElem (rheaGetElemByID("qrcode_plsWait"));
	
	rhea.ajax ("AliChinaAbort", "").then( function(result)
	{
		window.location = "pageMenu.html";
	})
	.catch( function(result)
	{
		window.location = "pageMenu.html";
	});
}

function onBtnStartSelection()
{
	clearInterval(timerGotoMainMenu);

	//se sono la preselezione JUG, alla pressione di start, memorizzo in session il fatto che JUG è attiva e torno al menu
	if (isJUG())
	{
		Rhea_session_setValue ("jug", selThatWasStarted);
		window.location = "pageMenu.html";
		return;
	}

	//info sulla selezione da erogare
	selThatWasStarted = detectCurrentSelection();
	var selInfo = rhea.selection_getBySelNumber(selThatWasStarted);
	var selPrice = selInfo.price;
	
	
	var dContent = rheaGetElemByID("rightPane_content");
	rheaHideElem(dContent);
	
	var dWait = rheaGetElemByID("rightPane_wait");
	rheaShowElem(dWait);
	
	rheaHideElem(rheaGetElemByID("divBtnHome")); //btn back
	rheaHideElem(rheaGetElemByID("divBtnSelectionInfo")); //btn selection info
	
	//mostro la rotellina al posto del qr code
	rheaHideElem (rheaGetElemByID("qrcode_payment"));
	rheaShowElem (rheaGetElemByID("qrcode_plsWait"));
	
	
	
	//nella preview di rheaMedia mostro un QR fake che autoscompare dopo 2 secondi e fa partire la selezione
	if (isRheamediaPreview())
	{
		//inizio conto alla rovescia
		btnAbort_countdown();
		showQRCode ("example qr code");
	}
	else if (parseFloat(selInfo.price) <= 0 || rhea.isFreevend)
	{
		//siamo in freevend oppure prezzo==0
		startCurrentSelWithPaymentConfirmed();
	}
	else
	{
		//inizio conto alla rovescia
		btnAbort_countdown();

		//chiedo il qrcode per il pagamento
		rhea.ajax ("AliChinaGetQR", {"name":iconDisplayName, "selNum":selThatWasStarted, "price":selPrice} ).then( function(result)
		{
			showQRCode (result);
		})
		.catch( function(result)
		{
			//console.log ("ERROR[" +result +"]");
			window.location = "pageMenu.html";
		});
	}
}

function showQRCode (url)
{
	console.log ("QR [" +url +"]");
	qrcode = new QRCode(document.getElementById("qrcode"), {
				text: url,
				width: 256,
				height: 256,
				colorDark : "#000000",
				colorLight : "#ffffff",
				correctLevel : QRCode.CorrectLevel.L
			});
	rheaHideElem (rheaGetElemByID("qrcode_plsWait"));
	rheaShowElem (rheaGetElemByID("qrcode_payment"));
}


function calcPriceMultiplier(selNum)
{
	if (jugConfiguration === JUG_STATUS.NEVER_VISIBLE)
		return 1;

	var priceMultiplier = 0;
	if (isRFIDJugDetected || btnJUG_isON())
		priceMultiplier = parseInt( rhea.selection_getBySelNumber(selNum).jug );
		
	if (priceMultiplier < 1)
		priceMultiplier = 1;
	return priceMultiplier;
}

function startCurrentSelWithPaymentConfirmed()
{
	clearInterval(timerGotoMainMenu);
	rheaHideElem(rheaGetElemByID("btnAbortPayment"));
	
	selThatWasStarted = detectCurrentSelection();
	var selInfo = rhea.selection_getBySelNumber(selThatWasStarted);
	var selPrice = selInfo.price * calcPriceMultiplier(selThatWasStarted);
	var selPaymentType=1; //alipayChina
	
	btnJUG_hide();

	resetTimerGotoPageMainMenu();
	console.log ("Starting sel num:" +selThatWasStarted);

	if (jugConfiguration === JUG_STATUS.NEVER_VISIBLE)
		rhea.selection_startAlreadyPaid (selThatWasStarted, selPrice, selPaymentType, 0);
	else {
		if( isRFIDJugDetected )
			rhea.selection_startAlreadyPaid (selThatWasStarted, selPrice, selPaymentType, 0);
		else {
			if (btnJUG_isON() )
				rhea.selection_startAlreadyPaid (selThatWasStarted, selPrice, selPaymentType, 1);
			else
				rhea.selection_startAlreadyPaid (selThatWasStarted, selPrice, selPaymentType, 0);
		}
	}
}

function gotoSelectionInfo()
{
	window.location = "pageSelectionInfo.html?iconMenu=" +iconNum;
}

function updateWifiIcon()
{
	console.log ("updateWifiIcon[" +rhea.isAlipayChinaOnline() +"]");
	var d = rheaGetElemByID ("divWIFI");
	if (rhea.isAlipayChinaOnline() || isRheamediaPreview())
	{
		rheaSetElemHTML (d, "<img src='img/wifi-on.png'>");
	}
	else
	{
		//wifi = off
		rheaSetElemHTML (d, "<img src='img/wifi-off.png'>");
		
	}

	//aggiorno lo stato del btn START
	var selNum = MMI_getLinkedSelectionNumber(iconNum);
	onSelectionChanged(selNum);
}


function resetTimerGotoPageMainMenu() 
{
	if (pageConfirmOptions.timeToMainMSec <= 1000)
		return;

	if (null != timerGotoMainMenu)
		clearInterval(timerGotoMainMenu);

	timerGotoMainMenu = setInterval(gotoPageMainMenu, pageConfirmOptions.timeToMainMSec);
}

function gotoPageMainMenu()  	{ window.location = "pageMenu.html";  }
function gotoRinsingPage()  	{ window.location = "rinsingPage.html";  }



//******************** btn jug
function classListContains (elem, what)
{
	for (var i=0; i<elem.classList.length; i++)
	{
		if (elem.classList[i] == what)
			return 1;
	}
	return 0;
}

function btnJUG_show()				{ rheaShowElem (rheaGetElemByID("btnJUG")); }
function btnJUG_hide()				{ rheaHideElem (rheaGetElemByID("btnJUG")); }
function btnJUG_setText(txt)		{ rheaSetElemHTML (rheaGetElemByID("btnJUG_text"), "JUG x " +txt); }
function btnJUG_isON()				{ var d = rheaGetElemByID("btnJUG"); return classListContains (d, "selected"); }

function btnJUG_setON()
{
	var d = rheaGetElemByID("btnJUG");
	if (classListContains (d, "selected"))
		return;
	rheaAddClassToElem(d,"selected");
}

function btnJUG_setOFF()
{
	var d = rheaGetElemByID("btnJUG");
	if (classListContains (d, "selected"))
	if ( jugConfiguration !== JUG_STATUS.ON_RFID_STATUS ) rheaRemoveClassToElem(d,"selected");
}

function onBtnJUGClicked ()
{
	if (btnJUG_isON())
		btnJUG_setOFF();
	else
		btnJUG_setON();
}

</script>


</html>
