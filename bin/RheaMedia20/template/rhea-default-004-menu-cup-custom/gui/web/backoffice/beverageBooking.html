<html>
<head>
	<title>GUI-Editor</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<script src="js/jquery-3.4.1.min.js"></script>
	<script src="js/jquery-ui-1-12-1/jquery-ui.min.js"></script>
	<script src="js/utils.js"></script>
	<link href="style.css" rel="stylesheet" type="text/css">
	<link href="js/jquery-ui-1-12-1/jquery-ui.min.css" rel="stylesheet" type="text/css">
	<link href="../../../../home/js/fileBrowser.css" rel="stylesheet" type="text/css">
</head>

<body onLoad="rheaBootstrapWithPathPrefix('../')">
<div id="mainWrapper" class="wrapper">
	<div id="main-content">
		<div class="header">
			<h1>Beverage booking</h1>
			<div id="tplPath">&nbsp;</div>
		</div>

		<div class="pulsantiera-sticky">
			<table border="0" cellspacing='0' cellpadding='2' width="100%">
				<tr valign="middle">
					<td width="33%" align="left"><a class="button giallo" href="index.html">BACK TO INDEX</a></td>
					<td width="34%" align="center"><a class="button verde" href="javascript:saveAll()">SAVE PAGE SETTINGS</a></td>
					<td width="33%" align="right"><a class="button arancione" href="javascript:onBtnBuildAndPreview()">Preview GUI and Export</a></td>
				</tr>
			</table>
		</div>			
		
		<div class="page">
			<div id="page-content">
				<div class="box">
					<h2>Repeat active</h2>
					<div class="box-content">
						Is repeat active:<select id="comboRepeatActive" class="combo" onchange="repeat_active_onchange()">
											<option value="0">No</option>
											<option value="1">Yes</option>
										</select> 
						<br>					
					</div>
				</div>

				<div id="divIfEnabled">
					<div class="box">
						<div class="box-content">
							<h2>Repeat settings</h2>
								<table border='0' cellspacing='0' cellpadding='2'>
									<tr valign="top">
										<td>BTN_REPEAT_LAST_DRINK:</td>
										<td>
											<div id="ml_BTN_REPEAT_LAST_DRINK"></div>
										</td>
									</tr>
									<tr valign="middle">
										<td></td>
									</tr>
									<tr valign="middle">
									<td>Repeat timeout:</td>
									<td>
										<p>Time to go back to main menu <input type="text" class="edit" onkeyup="javascript:onlyInteger(event)" style="width:80px; text-align:right" id="timeout"> sec</p>
									</td>	
									</tr>
								</table>
						</div>
					</div>				
				</div> <!-- divIfEnabled -->
			</div>
		</div>
	</div>
	
	<div id="main-content-wait" style="display:none">
		<br><br><br><br><br><br><br><br><br><br>
		<center><img src="img/animationRound.gif"></center>
		<div id="main-content-wait-msg" style="position:absolute; top:20px; left:20px; color:#fff;"></div>
	</div>
</div>

<div id="previewBox"></div>

<script id="rheaBootstrapTag" src="../js/rheaBootstrap.js"></script>
<script src="js/rheaDB.js"></script>
<script src="js/rheaFileUpload.js"></script>
<script src="js/buildConfigFile.js"></script>
<script src="js/multilangElem.js"></script>
<script src="../config/allowedLang.js"></script>
<script src="../../../../home/js/fileSaveAs.js"></script>
<script language="javascript">
var historyID = -1;
var db = null;
var ml_BTN_REPEAT_LAST_DRINK = null;

async function onRheaBootstrapFinished()
{
	var urlParams = getUrlVars();
	historyID = urlParams["his"];
	
	$("#main-content-wait").show();
	
	var curPath = rheaGetAbsolutePhysicalPath();
	db = new RheaDB (curPath +"/guidb.db3");

	// Get valore combo
    var comboValue = 0;
	var rst = await db.q("SELECT ValueA FROM other WHERE UID='pageBookingBev' AND ISO='xx' AND What='enable'");
	if (rst.getNumRows() == 0) {
		// Se non esiste inserisce il record con un default
		await db.exec ("INSERT INTO other(UID, ISO, What, ValueA) VALUES('pageBookingBev', 'xx', 'enable', '0')");
	} else {
		comboValue = rst.valByColName(0, "ValueA");
	}

    //Aggiorno combo
	rheaSelectComboOptionByValue(rheaGetElemByID("comboRepeatActive"), comboValue);

	//Carico e creo i controlli per il messaggio in ML	
	ml_BTN_REPEAT_LAST_DRINK = new MultilangElem("ml_BTN_REPEAT_LAST_DRINK", "BTN_REPEAT_LAST_DRINK", "MSG", "EDIT", "700px", allLang);
	await ml_BTN_REPEAT_LAST_DRINK.load(db);

	// Setto un default per la lingua inglese
	ml_BTN_REPEAT_LAST_DRINK.setText ("GB", "Repeat last drink");

	// Get valore timeout
	var timeout = 10000;
	var rst = await db.q("SELECT ValueA FROM other WHERE UID='pageBookingBev' AND ISO='xx' AND What='timeout'");
	if (rst.getNumRows() == 0) {
		// Se non esiste inserisce il record con un default
		await db.exec ("INSERT INTO other(UID, ISO, What, ValueA) VALUES('pageBookingBev', 'xx', 'timeout', '10000')");
	} else {
		timeout = rst.valByColName(0, "ValueA");
	}		

	document.querySelector('#timeout').value = Math.floor(timeout/1000);

	//Forzo evento onchange della combo per refreshare il container
	repeat_active_onchange();

	$("#main-content-wait").hide();
	$("#page-content").show();
	
	getCurrentPath();
}


function repeat_active_onchange()
{   
	 if (rheaGetComboSelectedOptionValue(rheaGetElemByID("comboRepeatActive")) == "1") {
	 	rheaShowElem(rheaGetElemByID("divIfEnabled"));
	 }
	 else {
	 	rheaHideElem(rheaGetElemByID("divIfEnabled"));	
	 }			
}

function getCurrentPath() {
	if (!rheaGetElemByID('tplPath')) { return; }

	var rheaobj = localStorage.getItem( 'rhea.data' );

	if (rheaobj && Object.keys( rheaobj = JSON.parse( rheaobj ) ).length && rheaobj.expires > new Date().getTime()) {
		rheaGetElemByID('tplPath').innerHTML = rheaobj.exportetTpl;
	} else {
		rheaGetElemByID('tplPath').innerHTML = rheaGetAbsolutePhysicalPath();
	}
}

async function saveAll()
{
	pleaseWait(1);

	//Salvataggio del valore della combo
    var comboValue = rheaGetComboSelectedOptionValue(rheaGetElemByID("comboRepeatActive"));
	var sql = "UPDATE other SET ValueA ='" + comboValue + "' WHERE UID='pageBookingBev' AND ISO='xx' AND What='enable'"; 
	await db.exec(sql);

	//Salvataggio del "messaggio" in multilingua
	await ml_BTN_REPEAT_LAST_DRINK.save(db);

	//Salvataggio del timeout
	var timeout = document.querySelector('#timeout').value * 1000;
	sql = "UPDATE other SET ValueA ='" + timeout + "' WHERE UID='pageBookingBev' AND ISO='xx' AND What='timeout'";	
	await db.exec(sql);

	await db.exec("UPDATE history SET DataUM='" +buildConfigFile_getAAAAMMGGHHMMSS() +"' WHERE ID=" +historyID);
	pleaseWait(0);
}
</script>
</html>
