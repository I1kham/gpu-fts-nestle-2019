<html>
<head>
	<title>GUI-Editor</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<script src="js/jquery-3.4.1.min.js"></script>
	<script src="js/jquery-ui-1-12-1/jquery-ui.min.js"></script>
	<script src="js/utils.js"></script>
	<link href="style.css" rel="stylesheet" type="text/css">
	<link href="js/jquery-ui-1-12-1/jquery-ui.min.css" rel="stylesheet" type="text/css">
	<link href="../styleOptionButtons.css" rel="stylesheet" type="text/css">
	<link href="../../../../home/js/fileBrowser.css" rel="stylesheet" type="text/css">
	<style>
		.box2 { margin:25px 0 25px 0; padding:20px 5px 20px 5px; border:solid 1px #ccc; }
		.container-middle { margin: auto; }
		.container-middle .center-vertical { display: inline-block; vertical-align: middle; }

		.popover-container { position: relative; cursor: pointer; }
		.popover-container[data-title]:hover::after {
			content: attr(data-title); margin-top: -15px; position: absolute; width: 200px; top: 13px; left: 28px;
			border: 1px solid #aaa; border-radius: 5px; color: #666666; padding: 3px 10px; box-shadow: 0px 0px 4px 1px rgb(0 0 0 / 50%);
			background-color: #efefef; z-index: 1;
		}
	</style>
</head>

<body onLoad="rheaBootstrapWithPathPrefix('../')">
<div id="mainWrapper" class="wrapper">
	<div id="main-content">
		<div class="header">
			<h1>Page General Menu Selections - Edit</h1>
			<div id="tplPath">&nbsp;</div>
		</div>

		<div class="pulsantiera-sticky">
			<table border="0" cellspacing='0' cellpadding='2' width="100%">
				<tr valign="middle">
					<td width="33%" align="left"><a class="button giallo" href="javascript:gotoMGEN()">BACK TO MGEN</a></td>
					<td width="34%" align="center"><a class="button verde" href="javascript:saveAll()">SAVE PAGE SETTINGS</a></td>
					<td width="33%" align="right"><a class="button arancione" href="javascript:onBtnBuildAndPreview()">Preview GUI and Export</a></td>
				</tr>
			</table>
		</div>	
		
		<div class="page">
			<div id="page-content">
				<div class="box">
					<h2 onclick="box_showHide('boxGeneralContent')" style="cursor:pointer">General settings</h2>
					<div class="box-closer" id="boxGeneralContent_arrow"><img src="img/dblArrowDown.png"></div>
					<div class="box-content" id="boxGeneralContent_content">					
						<div style="float:left; width:432px; overflow:hidden; margin-right:10px">
							<div style="width:432px; text-align:center">
								<div style="width:432px; height:204px; background-color:#fff; overflow:hidden; text-align:center; margin-top:5px">
									<img id="pageMenuGenImg" src="">
								</div>
								<div style="padding-bottom:10px; width: 280px; margin: 20px auto 0 auto">
									<a href="javascript:chooseImage()" class="button oro">Click here to select a Menu image from the repository</a>
									<br><br>
									<center>or</center><br>
									<div id="fileUpload2" style="width:280px" data-message="+<br><i style='font-size:0.3em'>drag an image here<br><br>(432x204 jpg/png image)</i>"></div>
									
								</div>
							</div>
						</div>
						
						<div style="float:left;">
							<table border='0' cellspacing='0' cellpadding='2'>
								<tr valign="top">
									<td>Menu name:</td><td><div id="MGEName"></div></td>
								</tr>
							</table>
							
							<table border='0' cellspacing='0' cellpadding='2' style="margin-top: .5em">
								<tr valign="top">
									<td>Second Menu name:</td>
									<td>
										<div id="MGENdName">
											<input type="text" id="MGENdName_input" class="edit" style="width:360px" value="">
										</div>
									</td>
								</tr>
							</table>



							<p class="container-middle">
								<span class="center-vertical">Menu number: </span> 
								<select id="selNoCustom_menuGenNum"class="combo center-vertical">
									<option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
								</select>
							</p>

							
							<div class="checkboxFive" data-input-id="cbKeyboardMenu"></div>Enable "only keyboard menu" option
							
					<!--		<p>Cup size: <select id="selNoCustom_cupSize" class="combo">
									<option value="S">Small</option>
									<option value="M">Medium</option>
									<option value="L">Large</option>
								</select>
							</p>  -->
							
							</div>
										
							<div style="float:left; margin-left:1px">
							keyboard value From<input type="text" class="edit" onkeyup="javascript:onlyInteger(event)" style="width:40px; text-align:right" id="idKeyboardDaSel">
						    To<input type="text" class="edit" onkeyup="javascript:onlyInteger(event)" style="width:40px; text-align:right" id="idKeyboardASel">
							<BR><BR>initial SNACK value  <input type="text" class="edit" onkeyup="javascript:onlyInteger(event)" style="width:50px; text-align:right" id="idKeyboardSnackValInit">
							</div>
							
							<div class="clear"></div>
						
					</div>
				</div> <!-- general settings -->
				
				<!-- selection description box -->
<!--				<div class="box">
					<h2 onclick="box_showHide('boxDescription')" style="cursor:pointer">Selection description</h2>
					<div class="box-closer" id="boxDescription_arrow"><img src="img/dblArrowRight.png"></div>
					<div class="box-content" id="boxDescription_content" style="display:none">
						<p>Enter the beverage description that will be shown on the "sell in progress page" (ie: during the beverage delivery).<br>
						You can customize the message for every supported language (click on the icon on the right of the box). If you leave blank the description for a certain language, then the description associated to the default language will be automatically used.</p>
					
						<div id="MGEDescr"></div>
						<br>&nbsp;
					</div>
				</div> <!-- selection description box -->
				

				<!-- Nutritional info box -->
<!--				<div class="box">
					<h2 onclick="box_showHide('boxNutritional')" style="cursor:pointer">Nutritional info</h2>
					<div class="box-closer" id="boxNutritional_arrow"><img src="img/dblArrowRight.png"></div>
					<div class="box-content" id="boxNutritional_content" style="display:none">
						<p>Drag & drop the image that will be shown on the "Nutritional info page". The image must be a jpg with a max resolution of 580x570 pixel.<br>
						You can upload a different image for each language. If you do not upload an image for a certain language, then the image associated with the default language will be automatically used.</p>
						<br>&nbsp;
						
						<ul id="boxNutri_langSelector" class="langSelector"></ul>
						<div class="clear"></div>
						
						<div style="float:left; margin:0 20px 0 10px">
							<div style="width:580px; height:570px; background-color:#fff; overflow:hidden; text-align:center;">
								<img id="pageNutriImg" src="">
							</div>
						</div>
						
						<div style="float:left;">
							<div id="fileUploadNutri" style="width:300px" data-message="+<br><i style='font-size:0.3em'>drag an image here<br><br>(max 580x570 jpg image)</i>"></div>
							<br><br>
							<br><br>
							<br><br>
							<center><a class="button rosso" href="javascript:boxNutri_deleteCurrentImage()">Delete current image</a></center>
						</div>
							
						<div class="clear"></div>
						<br>&nbsp;

					</div>
				</div> <!-- Nutritional info box -->
<!-- fine commento  -->
				<!-- Image in page confirm -->
				
<!--				<div class="box">
					<h2 onclick="box_showHide('boxConfirm')" style="cursor:pointer">Image in page confirm</h2>
					<div class="box-closer" id="boxConfirm_arrow"><img src="img/dblArrowRight.png"></div>
					<div class="box-content" id="boxConfirm_content" style="display:none">
						<p>By default, the picture shown in page confirm it's the exact same of the picture shown in main menu. Here, if you wish, you can select a different image that will be shown only in the confirm page.</p>
						
						<div class="checkboxFive" data-input-id="boxConfirm_cb1"></div>Use a different beverage picture for the "confirm page"
						<br>
						<br>
						
						<div id="boxConfirm_cnt1">
							<div style="float:left; margin:0 20px 0 10px">
								<div style="width:470px; height:376px; background-color:#fff; overflow:hidden; text-align:center;">
									<img id="pageConfirmImg" style="height:100%" src="">
								</div>
							</div>
						
							<div style="float:left;">
								<a href="javascript:chooseImage2()" class="button oro">Click here to select an image from the repository</a>
								<br><br>
								<center>or</center><br>
								<div id="fileUpload1" style="width:390px" data-message="+<br><i style='font-size:0.3em'>drag an image here<br><br>(max 470x376 jpg/png image)</i>"></div>
							</div>
							
							<div class="clear"></div>
						</div>
						
						<br>&nbsp;
					</div>
						
				</div>   -->      <!-- Image in page confirm -->


				
				<br><br><br><br>&nbsp;
			</div> <!-- page content -->
		</div>
	</div>
	
	<div id="main-content-wait" style="display:none">
		<br><br><br><br><br><br><br><br><br><br>
		<center><img src="img/animationRound.gif"></center>
		<div id="main-content-wait-msg" style="position:absolute; top:20px; left:20px; color:#fff;"></div>
	</div>
	
	<div id="divImageBrowser" class="imageBrowser" style="display:none">
	</div>
</div>

<div id="previewBox"></div>

<script id="rheaBootstrapTag" src="../js/rheaBootstrap.js"></script>
<script src="js/rheaDB.js"></script>
<script src="js/rheaFileUpload.js"></script>
<script src="js/buildConfigFile.js"></script>
<script src="js/multilangElem.js"></script>
<script src="../config/allowedLang.js"></script>
<script src="js/ImageBrowser.js"></script>
<script src="../../../../home/js/fileSaveAs.js"></script>
<script language="javascript">
var historyID = -1;
var UID = -1;
var db = null;
var ml_MGEName = null;
var ml_MGEDescr = null;
var imgBrowser = null;
var nutritionalInfoImg = [];
var mlAL = null;
var mlAR = null;
var mlBL = null;
var mlBR = null;
var dbData = null; // Contains used selections
var usedSelection 		  = {};
var usedSelectionOnChange = {};
var previousSelection;
var currentSelect;
var MENU_NUMBER = 4;



async function onRheaBootstrapFinished()
{
	var urlParams = getUrlVars();
	historyID = urlParams["his"];
	UID = urlParams["uid"];
	progressivo = urlParams["progr"];
	
	setupCheckboxes();
	imgBrowser = new ImageBrowser("divImageBrowser");
//	setupUploader("fileUpload1", upload1_onEnd);        //da reinserire
	setupUploader("fileUpload2", upload2_onEnd);
//	setupUploader("fileUploadNutri", uploadNutri_onEnd);
	
	$("#cbKeyboardMenu").on ("change", onCbKeyboardMenu_changed);
	$("#main-content-wait").show();
	// Prepares SELECTION combo elements
	bindEventComboSelection_onLoad();
	var curPath = rheaGetAbsolutePhysicalPath();
	db = new RheaDB (curPath +"/guidb.db3");

	if (UID < 0)
	{
		//new record
		UID = -1;
		$("#selNoCustom_menuGenNum").val(1);
//		$("#selNoCustom_cupSize").val("S");
//		$("#boxConfirm_cb1").prop('checked', false);
		$("#cbKeyboardMenu").prop('checked', false);
//		await db.exec ("DELETE FROM lang WHERE UID='MGE_NAME-1'");
	}
	else
		await loadExistingRecord();
		
//	onBoxConfirm_cb1_changed();
//    onCbKeyboardMenu_changed();
		
	ml_MGEName = new MultilangElem("MGEName", "MGE_NAME", UID, "EDIT", "360px", allLang);
	await ml_MGEName.load(db);
	
	ml_MGEDescr = new MultilangElem("MGEDescr", "MGE_DESCR", UID, "TEXTAREA", "600px", allLang);
	await ml_MGEDescr.load(db);
	
	//selettore lingue per la pagina NutritionalInfo
	var html = "";
	var langList = allLang.split(",");
//	for (var i=0; i<langList.length; i++)
//	{
//		nutritionalInfoImg[i] = "";
//		var css="";
//		if (i == 0)
//			css = "selected";
			
//		var id = "boxNutri_langSelector_" +i;
//		html += "<li id='" +id +"' class='" +css +"' onclick='boxNutri_langSelector_onClick(" +i +");'><img src='img/flags/" +langList[i] +".svg'></li>";
//	}
//	rheaSetDivHTMLByName ("boxNutri_langSelector", html);

//	let rst = await db.q("SELECT ISO,Message FROM lang WHERE UID='MMI_NUTRI' AND What='" +UID +"'");
//	for (var i=0; i<langList.length; i++)
//	{
//		var bAlreadyInDB = 0;
//		for (var r=0; r<rst.getNumRows(); r++)
//		{
//			var iso = rst.valByColName(r, "ISO");
//			if (iso == langList[i])
//			{
//				bAlreadyInDB = 1;
//				nutritionalInfoImg[i] = rst.valByColName(r, "Message");
//				if (nutritionalInfoImg[i] == "NULL")
//					nutritionalInfoImg[i] = "";
//				break;
//			}
//		}
		
//		if (!bAlreadyInDB)
//			await db.exec ("INSERT INTO lang (UID,ISO,What,Message) VALUES('MMI_NUTRI','" +langList[i] +"','" +UID +"','')");
//	}
//	boxNutri_langSelector_onChange();
	pleaseWait(0);		
	
	getCurrentPath();
}

function getCurrentPath() {
	if (!rheaGetElemByID('tplPath')) { return; }

	let rheaobj = localStorage.getItem( 'rhea.data' );

	if (rheaobj && Object.keys( rheaobj = JSON.parse( rheaobj ) ).length && rheaobj.expires > new Date().getTime()) {
		rheaGetElemByID('tplPath').innerHTML = rheaobj.exportetTpl;
	} else {
		rheaGetElemByID('tplPath').innerHTML = rheaGetAbsolutePhysicalPath();
	}
}

//*****************************************
async function loadExistingRecord()
{
	let rst = await db.q("SELECT * FROM pagemenu_menugen WHERE UID=" +UID);
	if (rst.hasError() != "")
	{
		alert ("loadExistingRecord::error [" +rst.hasError() +"]");
		return;
	}

	await db.dbConsistency( rst, 'pagemenu_menugen', 'secondName', 'TEXT(255)' );

	document.querySelector( '#MGENdName_input' ).value = 
		(rst.hasColName( 'secondName' ) && rst.valByColName(0, "secondName") !== 'NULL')?  rst.valByColName(0, "secondName") : '';

	var menuGenNum = rst.valByColName(0, "menuGenNum");
	var keyboard_daSelVal = rst.valByColName(0, "keyboard_daSel");
	var keyboard_aSelVal = rst.valByColName(0, "keyboard_aSel");
	var keyboard_SnackValInit = rst.valByColName(0, "keyboard_SnackValInit");	
	
	$("#pageMenuGenImg").attr("src", "../upload/" +rst.valByColName(0, "pageMenuGenImg"));
	if (rst.valByColName(0, "keyboardMenu") == 0)
	{
		$("#cbKeyboardMenu").prop('checked', false);
		keyboard_daSelVal=0;
		keyboard_aSelVal=0;
		keyboard_SnackValInit=0;
	}
	else
	{
		$("#cbKeyboardMenu").prop('checked', true);
	}

	//caso di cup non customizzata
	$("#selNoCustom_menuGenNum").val(menuGenNum);

	$("#idKeyboardDaSel").val(keyboard_daSelVal);
	$("#idKeyboardASel").val(keyboard_aSelVal);
	$("#idKeyboardSnackValInit").val(keyboard_SnackValInit);	
		
//	$("#selNoCustom_cupSize").val("S");
//	if (allowedCupSize=="010") $("#selNoCustom_cupSize").val("M");
//	if (allowedCupSize=="001") $("#selNoCustom_cupSize").val("L");
}


function gotoMGEN()
{
	window.location = "pageMainMenuGen.html?his=" +historyID +"&scrollTo=" +UID;
}


function queryNextProgressivo()
{
	return db.q("SELECT PROGR FROM pagemenu_menugen WHERE HIS_ID=" +historyID +" ORDER BY PROGR DESC LIMIT 1")
		.then ( function(rst)
		{
			var progressivo = 1;
			if (rst.getNumRows() > 0)
				progressivo = 1 + parseInt(rst.valByColName(0, "PROGR"));
			return progressivo;
		});
}


async function saveAll()
{
	var clickedKeyboardMenu = 0;
	if ($("#cbKeyboardMenu").prop('checked'))
		clickedKeyboardMenu = 1;			

	var keyboard_daSelVal = parseInt ($("#idKeyboardDaSel").val());
	var keyboard_aSelVal = parseInt ($("#idKeyboardASel").val());
	var keyboard_SnackValInit = parseInt ($("#idKeyboardSnackValInit").val());
	
	if (clickedKeyboardMenu == 1)
	{	
		if ((keyboard_daSelVal <0) || (keyboard_daSelVal >40))
		{
			alert ("the keboard value 'FROM' is not acceptable");
			return;
		}
	
		if ((keyboard_aSelVal <0) || (keyboard_aSelVal >40))
		{
			alert ("the keboard value 'TO' is not acceptable");
			return;
		}	
	
		if ((keyboard_aSelVal < keyboard_daSelVal))
		{
			alert ("range keboard values is not acceptable");
			return;
		}	
	}
	else	
	{
		keyboard_daSelVal = 0;
		keyboard_aSelVal = 0;
		keyboard_SnackValInit = 0;
	}
	
	box_showItNow("boxGeneralContent");
	
	let progressivo;
	var sql = "";
	var err = "";
	
	var menuName = $("#MGEName_" +defaultLang).val().trim();
	if (menuName == "")
		err += "Selection name (" +defaultLang +") is mandatory.\n";
		
	var menuNdName = $("#MGENdName_input").val().trim();

	var pageMenuGenImg = getFilenameFromPath($("#pageMenuGenImg").attr("src"));
	if (pageMenuGenImg == "")
		err += "Selection image is mandatory.\n";
	
	var menuGenNum = parseInt ($("#selNoCustom_menuGenNum").val());	
	var linkedMenu=menuGenNum;
	
	if (UID == -1)
	{
		//calcolo il progressivo per il nuovo MGE
		progressivo = await queryNextProgressivo();
			
		//preparo insert
		sql = "INSERT INTO pagemenu_menugen (HIS_ID,PROGR,menuGenNum,pageMenuGenImg,linkedMenu,name,secondName,keyboardMenu,keyboard_daSel,keyboard_aSel,keyboard_SnackValInit) VALUES("
				+historyID
				+"," +progressivo
				+"," +menuGenNum
				+",'" +pageMenuGenImg +"'"
				+",'" +linkedMenu +"'"
				+",'" +db.toDBString(menuName) +"'"
				+",'" +db.toDBString(menuNdName) +"'"
				+",'" +clickedKeyboardMenu +"'"
				+",'" +keyboard_daSelVal +"'"
				+",'" +keyboard_aSelVal +"'"
				+",'" +keyboard_SnackValInit +"'"
				+")";							
	}
	else
	{
		sql = "UPDATE pagemenu_menugen SET"
				+" menuGenNum=" +menuGenNum
				+",pageMenuGenImg='" +pageMenuGenImg +"'"
				+",linkedMenu='" +linkedMenu +"'"
				+",name='" +db.toDBString(menuName) +"'"
				+",secondName='" +db.toDBString(menuNdName) +"'"
				+",keyboardMenu='"+clickedKeyboardMenu+"'"
				+",keyboard_daSel='" +keyboard_daSelVal +"'"
				+",keyboard_aSel='" +keyboard_aSelVal +"'"
				+",keyboard_SnackValInit='" +keyboard_SnackValInit +"'"				
				+" WHERE UID=" +UID;
	}

	
	
	
	//se durante la raccolta dati ho notato degli errori, avviso e mi fermo
	if (err != "")
	{
		alert (err);
		return;
	}
	
	/* Check if exist secondName column*/
	let rst = await db.q("SELECT * FROM pagemenu_menugen WHERE UID=" + UID);
	await db.dbConsistency( rst, 'pagemenu_menugen', 'secondName', 'TEXT(255)' );

	pleaseWait(1);
	await db.exec(sql);

	//salvataggio del nome MGE in multilingua
	await ml_MGEName.save(db);
	await ml_MGEDescr.save(db);

	//se era un record nuovo...
	if (sql.substr(0,6) == "INSERT")
	{
		//recupero UID di questo elemento che ho appena creato
		let rst = await db.q("SELECT UID FROM pagemenu_menugen WHERE HIS_ID=" +historyID +" AND PROGR="+progressivo);
		UID = rst.valByColName(0, "UID");
		await db.exec ("DELETE FROM lang WHERE What='" +UID +"' AND UID IN ('MGE_NAME','MGE_DESCR')");
		await db.exec ("UPDATE lang SET What='" +UID +"' WHERE What='-1' AND UID IN ('MGE_NAME','MGE_DESCR')");
	}
	
	await db.exec ("UPDATE history SET DataUM='" +buildConfigFile_getAAAAMMGGHHMMSS() +"' WHERE ID=" +historyID);
	
	gotoMGEN();
}


function chooseImage()
{
	var curPath = rheaGetAbsolutePhysicalPath() +"/img-menu";
	imgBrowser.open (curPath, "*.png *.gif", chooseImage_onEnd);
}

function chooseImage_onEnd(selectedFileName, selectedPath)
{
	if (selectedFileName=="")
		return;
	console.log ("[" +selectedFileName +"] [" +selectedPath +"]");
	
	pleaseWait(1);
	var pDST = rheaGetAbsolutePhysicalPath() +"/../upload";
	rhea.ajax ("FSCopy", { "pSRC" : selectedPath, "fSRC":selectedFileName, "pDST" : pDST, "fDST":selectedFileName})
		.then( function(result)
		{
			pleaseWait(0);
			$("#pageMenuGenImg").attr("src", "../upload/" +selectedFileName);	
		})
		.catch ( function(result)
		{
			pleaseWait(0);
		});
}

function upload2_onEnd (fileName, userValue, error_code)
{
	//console.log ("upload2_onEnd [" +userValue +"][" +error_code +"]");
	if (error_code != 0)
		return;
	$("#pageMenuGenImg").attr("src", "../upload/" +fileName);
}


/*********************************************************
 *
 * image in page configrm
 *
 */
function chooseImage2()
{
	var curPath = rheaGetAbsolutePhysicalPath() +"/img-menu";
	imgBrowser.open (curPath, "*.png *.gif", chooseImage_onEnd2);
}

function chooseImage_onEnd2(selectedFileName, selectedPath)
{
	if (selectedFileName=="")
		return;
	console.log ("[" +selectedFileName +"] [" +selectedPath +"]");
	
	pleaseWait(1);
	var pDST = rheaGetAbsolutePhysicalPath() +"/../upload";
	rhea.ajax ("FSCopy", { "pSRC" : selectedPath, "fSRC":selectedFileName, "pDST" : pDST, "fDST":selectedFileName})
		.then( function(result)
		{
			pleaseWait(0);
			$("#pageConfirmImg").attr("src", "../upload/" +selectedFileName);	
		})
		.catch ( function(result)
		{
			pleaseWait(0);
		});
}

function upload1_onEnd (fileName, userValue, error_code)
{
	console.log ("upload1_onEnd [" +userValue +"][" +error_code +"]");
	if (error_code != 0)
		return;
	$("#pageConfirmImg").attr("src", "../upload/" +fileName);
}


function box_showHide(elemID)
{
	var cnt = $("#" +elemID +"_content");
	var arrow = $("#" +elemID +"_arrow");
	if (cnt.css("display") == "none")
	{
		cnt.slideDown();
		arrow.html ("<img src='img/dblArrowDown.png'>");
	}
	else
	{
		cnt.slideUp();
		arrow.html ("<img src='img/dblArrowRight.png'>");
	}
}

function box_showItNow(elemID)
{
	var cnt = $("#" +elemID +"_content");
	if (cnt.css("display") == "none")
	{
		cnt.slideDown(1);
		$("#" +elemID +"_arrow").html ("<img src='img/dblArrowDown.png'>");
	}
}

function onCbKeyboardMenu_changed()
{
//	if ($("#boxConfirm_cb1").prop('checked'))
//		$("#boxConfirm_cnt1").show();
//	else
//		$("#boxConfirm_cnt1").hide();
}


/***********************************************************************
 *
 * page Nutritional info
 *
 ***********************************************************************/
/* function boxNutri_langSelector_onClick(iClicked)
{
	var langList = allLang.split(",");
	for (var i=0; i<langList.length; i++)	
	{
		var e = rheaGetElemByID("boxNutri_langSelector_" +i);
		rheaRemoveClassToElem(e,"selected");
	}
	var e = rheaGetElemByID("boxNutri_langSelector_" +iClicked);
	rheaAddClassToElem(e,"selected");
	boxNutri_langSelector_onChange();
} */

/* function boxNutri_langSelector_getIndexOfCurrentSelectedLang()
{
	var langList = allLang.split(",");
	for (var i=0; i<langList.length; i++)	
	{
		if ($("#boxNutri_langSelector_" +i).hasClass("selected"))
			return i;
	}
	return 0;
}
*/

function boxNutri_langSelector_onChange()
{
	var i = boxNutri_langSelector_getIndexOfCurrentSelectedLang();
	$("#pageNutriImg").attr("src", "../upload/" +nutritionalInfoImg[i]);
}

function uploadNutri_onEnd (fileName, userValue, error_code)
{
	if (error_code != 0)
		return;
	
	var i = boxNutri_langSelector_getIndexOfCurrentSelectedLang();
	nutritionalInfoImg[i] = fileName;
	$("#pageNutriImg").attr("src", "../upload/" +nutritionalInfoImg[i]);
}

function boxNutri_deleteCurrentImage ()
{
	var i = boxNutri_langSelector_getIndexOfCurrentSelectedLang();
	nutritionalInfoImg[i] = "";
	$("#pageNutriImg").attr("src", "../upload/" +nutritionalInfoImg[i]);
}
function bindEventComboSelection_onLoad() {
	var btnAnchorInfo = document.createElement( 'a' );
		btnAnchorInfo.className = 'center-vertical popover-container';
		btnAnchorInfo.setAttribute( 'onmouseover', 'btnSelectionAvailable_onClick()');
		btnAnchorInfo.setAttribute( 'data-title', ' ');
	
	var imgInfo = document.createElement( 'img' );
		imgInfo.setAttribute( 'alt', 'Info');
		imgInfo.setAttribute( 'src', 'img/icon_info24.png');

	btnAnchorInfo.appendChild( imgInfo );

	document.querySelectorAll('select').forEach( s => {
		// Is a selection combo
		if( s.options.length === MENU_NUMBER ) {
			s.setAttribute( 'onchange', 'btnSelectionAvailable_onClick(this)' );
			s.setAttribute( 'onclick', 'previousSelectionOption(this)' );
			
			var wrapper = wrapHTMLElement(s, 'div', 'center-vertical container-middle');
			wrapper.innerHTML += btnAnchorInfo.outerHTML;
		}
	});
}

function btnSelectionAvailable_onClick($event) {
	if( !db ) return;
	
	if( !dbData ) {
		var QUERY = 'SELECT linkedSelection FROM pagemenu_menugen';
	
		db.q( QUERY ).then( res => {
			dbData = res && res.data;

			findFirstAvailableSelection($event);
			return;
		});
	} else {
		findFirstAvailableSelection($event);
	}
}

function findFirstAvailableSelection($event) {
	var firstAvailableSelection;

	if( !dbData ) {return};

	// If first time, get selection from DB
	if( !Object.keys(usedSelection).length ) {
		dbData.forEach( colVal => {
			if( colVal && colVal.indexOf( ',' ) !== -1 ) {
				var tmpArrValue = colVal.split( ',' ) || [];
				
				tmpArrValue.forEach( selection => {
					var s = parseInt( selection );

					if( !usedSelection.hasOwnProperty( s ) ) {
						usedSelection[ s ] = true;
					}
				});
			}
		});

		usedSelectionOnChange = JSON.parse(JSON.stringify(usedSelection));
	}
	
	if( $event ) {
		var selection = parseInt( $event.value );
 		
		usedSelectionOnChange[previousSelection] = false;

		if( !usedSelectionOnChange.hasOwnProperty( selection ) || !usedSelectionOnChange[selection] ) {
			usedSelectionOnChange[ selection ] = true;
		}
	}

	document.querySelectorAll('select').forEach( s => {
		// Is a selection combo
		if( s.options.length === MENU_NUMBER ) {
			usedSelectionOnChange[s.value] = true;
		}
	});

	for( var i=1; i<=48; i++ ) {
		if( !usedSelectionOnChange[i] ) {
			firstAvailableSelection = i;
			break;
		}
	}

	document.querySelectorAll( '[data-title]' ).forEach( popover => {
		popover.dataset.title = + firstAvailableSelection + ', is the first available selection';
	});
}


function previousSelectionOption($event) {
	if(!previousSelection ) { previousSelection = $event.value; }
	if(!currentSelect ) { currentSelect = $event.id; }
	
	if( previousSelection === $event.value || currentSelect != $event.id ) {
		previousSelection = $event.value;
		currentSelect = $event.id;

		usedSelectionOnChange = JSON.parse( JSON.stringify( usedSelection ) );
	}	
}




</script>
</html>
